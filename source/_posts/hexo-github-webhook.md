---
title: Собираем статичный сайт на сервере используя Webhooks в github
tags:
  - github
  - hexo
  - php
date: 2015-07-30 06:01:47
category:
---

Давно хотел попробовать использовать Webhooks в github для чего-нибудь полезного, и вот наконец представился такой случай.

Итак имеется статичный сайт который генерируется на рабочем компьютере. И есть необходимость как то упростить процесс редактирования и добавления материалов на сайт. Ко всему прочему не хочется быть привязанным к одному компьютеру. Для решения этих вопросов я пришел к следующему решению:
- Исходники сайта хранятся в репозитории github. Это позволит работать с сайтом используя только github + появляется возможность делать pull-request с исправлениями :)
- После коммита сервер где хостится наш сайт подтягиват последнюю версию из репозитория, а далее генерирует и публикует все необходимые файлы.

<!-- more -->

В качестве генератора сайта я использовал [hexo](https://hexo.io/), но данный метод подойдет для любого подобного решения.

Итак сайт у нас есть, далее размещаем исходники на github. И переходим к основному вопросу. Как заставить наш сервер обновлять сайт после коммита в репозиторий. В этом нам помогут webhooks. В настройках вашего репозитория есть раздел Webhooks & Services `https://github.com/ЛОГИН/ИМЯ_РЕПОЗИТОРИЯ/settings/hooks`. Тут необходимо заполнить всего 2 поля:

- **Payload URL** - адрес скрипта который запустит обновление сайта на сервере.
- **Secret** - случайный хэш который известен только вам и гитхабу.

{% img image-border /images/hexo-github-webhook.png %}

Важно заметить что Payload URL должен вести к файлу на сервере которыый будет разворачивать наш сайт. Т.е. мы можем для этих целей сделать отдельный поддомен и разместить скрип "на отдельном" сайте. В моем случае скрипт лежит в репозитории с сайтом, т.о. я могу обновлять и сам скрипт. Тут нужо быть внимательным и не закинуть в файл чего лишнего (Secret, абсолютные пути к файлам или какой то дополнительный функционал).

Далее переходим к подготовке самого сервера. В моем случае кореневая директория сайта `public_html`. В той же папке где и `public_html` мы клонируем наш репозиторий в папку `repo`

``` bash
$ git clone https://github.com/zb3k/devhook.net.git repo
```

В случае с hexo, нужно установить [node.js](http://nodejs.org) и [hexo-cli](https://hexo.io/). После чего установить необходимые пакты

``` bash
$ cd ./repo/ && npm install
```

Далее убедимся что все работавет

``` bash
$ hexo generate
```

Теперь займемся нашим скриптом. Во первых создадим файл с секретной фразой.

``` bash
$ cd ../
$ echo -n "СЕКРЕТНАЯ ФРАЗА" >> .github_secret
```

Т.е. у нас должна получиться следуюящая структура файлов:

``` bash
[public_html]
[repo]
.github_secret
```

Далее в `public_html` создаем файл `webhook.php` к которому будет обращаться github.

``` php
<?php

// Файл с секретной фразой (Secret) заданной в настройках вебхука github
$secret = file_get_contents('../.github_secret');

// Получаем хэш-подпись и название алгоритма шифрования
$headers = getallheaders();

list($algo, $hash) = explode('=', $headers['X-Hub-Signature'], 2);

// Получаем тело запроса
$payload = file_get_contents('php://input');

// Проверяем соответствие хэшей
$payload_hash = hash_hmac($algo, $payload, $secret);
if ($hash !== $payload_hash) {
    // Останавливаем выполнение скрипта
    header('HTTP/1.0 401 Unauthorized');
    die('401 Unauthorized');
}

// Начинаем обновлять сайт...

header('Content-Type: text/plain');
chdir('../repo');

// Сбрасываем все изменения и подтягиваем последнюю версию сайта из репозитория
shell_exec('git reset --hard');
shell_exec('git pull');

// Устанавливаем необходимые настройки hexo
shell_exec('hexo config render_drafts false'); // не редерить черновики
shell_exec('hexo config public');
shell_exec('hexo config url http://devhook.net');

// Пытаемся сгенерировать статичный сайт
$result = shell_exec('hexo generate -f');

// Если небыло ошибок то сохраняем текущий сайт в public_html.bak
// и публикуем свежую версию
if (strpos($result, 'ERROR') === false) {
    shell_exec('rm -rf ../public_html.bak');
    shell_exec('mv ../public_html ../public_html.bak');
    shell_exec('mv public ../public_html');
} else {
    // Сообщаем githab-у что webhook выполнен с ошибкой
    header($_SERVER['SERVER_PROTOCOL'] . ' 500 Internal Server Error', true, 500);
}

echo $result;

```

После этого можно сделать коммит и посмотреть в настройках хука результат выполнения скрипта.

{% img image-border /images/hexo-github-webhook-2.png %}

**tada!** Теперь можно редактировать и добавлять статьи прямо на гитхабе.